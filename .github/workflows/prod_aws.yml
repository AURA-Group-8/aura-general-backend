name: Deploy Backend EC2 Duo

on:
  push:
    branches: [ "producao-aws" ]

jobs:

  # =====================================================
  # JOB 1 — MÁQUINA 1 (build normal)
  # =====================================================
  deploy-machine-1:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build Maven (default)
        run: mvn -B clean package -DskipTests

      - name: Copy JAR to EC2 Machine 1
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_1 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/*.jar"
          target: "/home/${{ secrets.EC2_USER }}/app"

      - name: Restart service on EC2 Machine 1
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_1 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl stop backend.service || true
            sudo cp /home/${{ secrets.EC2_USER }}/app/*.jar /aura/aura-general-backend/target/general-backend-0.0.1-SNAPSHOT.jar
            sudo chmod 755 /aura/aura-general-backend/target/general-backend-0.0.1-SNAPSHOT.jar
            sudo systemctl start backend.service


  # =====================================================
  # JOB 2 — MÁQUINA 2 (build com whitelabel desativado)
  # =====================================================
  deploy-machine-2:
    runs-on: ubuntu-latest
    needs: deploy-machine-1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # DESABILITA WHITELABEL
      - name: Disable Whitelabel Error Page
        run: |
          echo "server.error.whitelabel.enabled=false" >> src/main/resources/application.properties

      - name: Build Maven (whitelabel disabled)
        run: mvn -B clean package -DskipTests

      - name: Copy JAR to EC2 Machine 2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_2 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/*.jar"
          target: "/home/${{ secrets.EC2_USER }}/app"

      - name: Restart service on EC2 Machine 2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_2 }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl stop backend.service || true
            sudo cp /home/${{ secrets.EC2_USER }}/app/*.jar /aura/aura-general-backend/target/general-backend-0.0.1-SNAPSHOT.jar
            sudo chmod 755 /aura/aura-general-backend/target/general-backend-0.0.1-SNAPSHOT.jar
            sudo systemctl start backend.service
