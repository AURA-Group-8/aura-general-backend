


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SchedulingService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.aura8.general_backend.service</a>
</div>

<h1>Coverage Summary for Class: SchedulingService (com.aura8.general_backend.service)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SchedulingService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    6,2%
  </span>
  <span class="absValue">
    (1/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    4,2%
  </span>
  <span class="absValue">
    (5/120)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.aura8.general_backend.service;
&nbsp;
&nbsp;import com.aura8.general_backend.dtos.finance.MonthDataDto;
&nbsp;import com.aura8.general_backend.dtos.jobscheduling.AvailableDayDto;
&nbsp;import com.aura8.general_backend.dtos.jobscheduling.SchedulingCardResponseDto;
&nbsp;import com.aura8.general_backend.dtos.jobscheduling.SchedulingPatchRequestDto;
&nbsp;import com.aura8.general_backend.dtos.schedulingsettings.SchedulingSettingsListEnumDto;
&nbsp;import com.aura8.general_backend.dtos.schedulingsettings.SchedulingSettingsMapper;
&nbsp;import com.aura8.general_backend.entities.Scheduling;
&nbsp;import com.aura8.general_backend.entities.SchedulingSettings;
&nbsp;import com.aura8.general_backend.entities.Users;
&nbsp;import com.aura8.general_backend.enums.DayOfWeekEnum;
&nbsp;import com.aura8.general_backend.enums.PaymentStatus;
&nbsp;import com.aura8.general_backend.enums.SchedulingStatus;
&nbsp;import com.aura8.general_backend.event.SchedulingCreateEvent;
&nbsp;import com.aura8.general_backend.exception.ElementNotFoundException;
&nbsp;import com.aura8.general_backend.repository.SchedulingRepository;
&nbsp;import org.springframework.context.ApplicationEventPublisher;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.time.DayOfWeek;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.time.LocalTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@Service
&nbsp;public class SchedulingService {
&nbsp;
&nbsp;    private final ApplicationEventPublisher publisher;
&nbsp;    private final SchedulingRepository schedulingRepository;
&nbsp;    private final UsersService usersService;
&nbsp;    private final SchedulingSettingsService schedulingSettingsService;
&nbsp;
<b class="fc">&nbsp;    public SchedulingService(ApplicationEventPublisher publisher, SchedulingRepository schedulingRepository, UsersService usersService, SchedulingSettingsService schedulingSettingsService) {</b>
<b class="fc">&nbsp;        this.publisher = publisher;</b>
<b class="fc">&nbsp;        this.schedulingRepository = schedulingRepository;</b>
<b class="fc">&nbsp;        this.usersService = usersService;</b>
<b class="fc">&nbsp;        this.schedulingSettingsService = schedulingSettingsService;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Scheduling findById(Integer id) {
<b class="nc">&nbsp;        return schedulingRepository.findById(id).orElseThrow(</b>
<b class="nc">&nbsp;                () -&gt; (new ElementNotFoundException(&quot;Scheduling de ID: %d não foi encontrado&quot;.formatted(id)))</b>
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    public Scheduling create(Scheduling scheduling, Integer userId) {
<b class="nc">&nbsp;        Users user = usersService.getUserById(userId);</b>
<b class="nc">&nbsp;        scheduling.setUsers(user);</b>
<b class="nc">&nbsp;        scheduling.setPaymentStatus(PaymentStatus.PENDENTE);</b>
<b class="nc">&nbsp;        scheduling.setStatus(SchedulingStatus.PENDENTE);</b>
<b class="nc">&nbsp;        Boolean isAdminScheduling = user.getRole().getName().equals(&quot;ADMIN&quot;);</b>
<b class="nc">&nbsp;        publisher.publishEvent(new SchedulingCreateEvent(this, isAdminScheduling, user, scheduling));</b>
<b class="nc">&nbsp;        return schedulingRepository.save(scheduling);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Page&lt;Scheduling&gt; findAll(Pageable pageable) {
<b class="nc">&nbsp;        return schedulingRepository.findAll(pageable);</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;AvailableDayDto&gt; getAvailableTimes(Integer durationInMinutes, LocalDate firstDayOfWeek) {
<b class="nc">&nbsp;        LocalDate today = firstDayOfWeek;</b>
<b class="nc">&nbsp;        int dayOfWeeek = today.getDayOfWeek().getValue();</b>
<b class="nc">&nbsp;        if (dayOfWeeek == 7) {</b>
<b class="nc">&nbsp;            dayOfWeeek = 0; // Ajusta para que domingo seja o primeiro dia da semana</b>
&nbsp;        }
<b class="nc">&nbsp;        LocalDate startOfWeek = today.minusDays(dayOfWeeek);</b>
<b class="nc">&nbsp;        int daysToNextWeek = 6 - dayOfWeeek;</b>
<b class="nc">&nbsp;        List&lt;Scheduling&gt; schedulings = schedulingRepository.findByStartDatetimeBetweenAndIsCanceledFalse(startOfWeek.atStartOfDay(), today.plusDays(daysToNextWeek).atStartOfDay());</b>
<b class="nc">&nbsp;        SchedulingSettings schedulingSettings = schedulingSettingsService.getSchedulingSettings();</b>
<b class="nc">&nbsp;        SchedulingSettingsListEnumDto settings = SchedulingSettingsMapper.toListEnumDto(schedulingSettings);</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;LocalDate&gt; dates = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; 7; i++) {</b>
<b class="nc">&nbsp;            dates.add(startOfWeek.plusDays(i));</b>
&nbsp;        }
<b class="nc">&nbsp;        List&lt;AvailableDayDto&gt; availableDays = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (LocalDate date : dates) {</b>
<b class="nc">&nbsp;            AvailableDayDto availableDay = new AvailableDayDto();</b>
<b class="nc">&nbsp;            availableDay.setDate(date);</b>
<b class="nc">&nbsp;            availableDay.setAvailable(true); // Inicialmente assume que o dia está disponível</b>
<b class="nc">&nbsp;            availableDay.setAvailableTimes(new ArrayList&lt;&gt;());</b>
<b class="nc">&nbsp;            availableDay.setWeekDay(DayOfWeekEnum.getNameByNumber(date.getDayOfWeek().getValue()));</b>
&nbsp;
<b class="nc">&nbsp;            List&lt;Scheduling&gt; dailySchedulings = schedulings.stream()</b>
<b class="nc">&nbsp;                    .filter(scheduling -&gt; scheduling.getStartDatetime().toLocalDate().equals(date))</b>
<b class="nc">&nbsp;                    .toList();</b>
&nbsp;
<b class="nc">&nbsp;            List&lt;DayOfWeek&gt; avaliablesWeekDays = settings.getDaysOfWeek();</b>
&nbsp;            // Verifica se o dia está disponível nas configurações
<b class="nc">&nbsp;            if (!avaliablesWeekDays.contains(date.getDayOfWeek())) {</b>
<b class="nc">&nbsp;                availableDay.setAvailable(false); // Dia não disponível</b>
&nbsp;            } else {
&nbsp;                // Adiciona os horários disponíveis baseados nas configurações
<b class="nc">&nbsp;                LocalTime startTime = settings.getWorkStart();</b>
<b class="nc">&nbsp;                LocalTime endTime = settings.getWorkEnd();</b>
<b class="nc">&nbsp;                LocalTime breakStart = settings.getBreakStart();</b>
<b class="nc">&nbsp;                LocalTime breakEnd = settings.getBreakEnd();</b>
&nbsp;
&nbsp;                // Adiciona os horários antes do intervalo de almoço
<b class="nc">&nbsp;                while (startTime.isBefore(breakStart)) {</b>
<b class="nc">&nbsp;                    availableDay.getAvailableTimes().add(startTime);</b>
<b class="nc">&nbsp;                    startTime = startTime.plusMinutes(30);</b>
&nbsp;                }
&nbsp;
&nbsp;                // Adiciona os horários após o intervalo de almoço
<b class="nc">&nbsp;                startTime = breakEnd;</b>
<b class="nc">&nbsp;                while (startTime.isBefore(endTime)) {</b>
<b class="nc">&nbsp;                    availableDay.getAvailableTimes().add(startTime);</b>
<b class="nc">&nbsp;                    startTime = startTime.plusMinutes(30);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            availableDay.getAvailableTimes().removeIf(time -&gt; (time.plusMinutes(durationInMinutes).isAfter(settings.getWorkEnd())));</b>
&nbsp;
&nbsp;            // Remove os horários que já estão ocupados
<b class="nc">&nbsp;            for (Scheduling scheduling : dailySchedulings) {</b>
<b class="nc">&nbsp;                LocalTime start = scheduling.getStartDatetime().toLocalTime();</b>
<b class="nc">&nbsp;                LocalTime end = scheduling.getEndDatetime().toLocalTime();</b>
&nbsp;
&nbsp;                // Remove os horários ocupados
<b class="nc">&nbsp;                availableDay.getAvailableTimes().removeIf(time -&gt;</b>
<b class="nc">&nbsp;                        (time.isAfter(start) &amp;&amp; time.isBefore(end)) ||</b>
<b class="nc">&nbsp;                                (time.plusMinutes(durationInMinutes).isAfter(start) &amp;&amp; time.plusMinutes(durationInMinutes).isBefore(end)) ||</b>
<b class="nc">&nbsp;                                (time.equals(start) || time.plusMinutes(durationInMinutes).equals(end))</b>
&nbsp;                );
&nbsp;
&nbsp;                // Se não houver horários disponíveis, marca o dia como indisponível
<b class="nc">&nbsp;                if (availableDay.getAvailableTimes().isEmpty()) {</b>
<b class="nc">&nbsp;                    availableDay.setAvailable(false);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            availableDays.add(availableDay);</b>
&nbsp;        }
<b class="nc">&nbsp;        return availableDays;</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;SchedulingCardResponseDto&gt; getCardInfos() {
<b class="nc">&nbsp;        List&lt;SchedulingCardResponseDto&gt; cards = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        List&lt;Scheduling&gt; schedulings = schedulingRepository.findAll();</b>
<b class="nc">&nbsp;        schedulings.forEach(scheduling -&gt; {</b>
<b class="nc">&nbsp;            SchedulingCardResponseDto card = new SchedulingCardResponseDto();</b>
<b class="nc">&nbsp;            card.setIdScheduling(scheduling.getId());</b>
<b class="nc">&nbsp;            card.setUserName(scheduling.getUsers().getUsername());</b>
<b class="nc">&nbsp;            card.setStartDatetime(scheduling.getStartDatetime());</b>
<b class="nc">&nbsp;            card.setEndDatetime(scheduling.getEndDatetime());</b>
<b class="nc">&nbsp;            card.setTotalPrice(scheduling.getTotalPrice());</b>
<b class="nc">&nbsp;            card.setPaymentStatus(scheduling.getPaymentStatus().getDescription());</b>
<b class="nc">&nbsp;            card.setStatus(scheduling.getStatus().getStatus());</b>
<b class="nc">&nbsp;            cards.add(card);</b>
&nbsp;        });
<b class="nc">&nbsp;        return cards;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Scheduling update(Integer id, SchedulingPatchRequestDto schedulingPatchRequestDto) {
<b class="nc">&nbsp;        Scheduling scheduling = findById(id);</b>
<b class="nc">&nbsp;        schedulingPatchRequestDto.setId(id);</b>
<b class="nc">&nbsp;        if (schedulingPatchRequestDto.getFeedback() != null) {</b>
<b class="nc">&nbsp;            scheduling.setFeedback(schedulingPatchRequestDto.getFeedback());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (schedulingPatchRequestDto.getStatus() != null) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                scheduling.setStatus(SchedulingStatus.valueOf(schedulingPatchRequestDto.getStatus()));</b>
&nbsp;            } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;                throw new ElementNotFoundException(&quot;Status de agendamento inválido: %s. Tente: [FEITO, PENDENTE, CANCELADO]&quot;.formatted(schedulingPatchRequestDto.getStatus()));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (schedulingPatchRequestDto.getPaymentStatus() != null) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                scheduling.setPaymentStatus(PaymentStatus.valueOf(schedulingPatchRequestDto.getPaymentStatus()));</b>
&nbsp;            } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;                throw new ElementNotFoundException(&quot;Status de pagamento inválido: %s. Tente: [PAGO, PENDENTE]&quot;.formatted(schedulingPatchRequestDto.getPaymentStatus()));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return schedulingRepository.save(scheduling);</b>
&nbsp;    }
&nbsp;
&nbsp;    public MonthDataDto generateFinanceMonthData(LocalDate month) {
<b class="nc">&nbsp;        LocalDateTime startOfMonth = month.withDayOfMonth(1).atStartOfDay();</b>
<b class="nc">&nbsp;        LocalDateTime endOfMonth = month.withDayOfMonth(month.lengthOfMonth()).atTime(23, 59, 59);</b>
<b class="nc">&nbsp;        Double totalFaturadoMes = schedulingRepository.getTotalFaturadoMes(startOfMonth, endOfMonth);</b>
<b class="nc">&nbsp;        Integer totalAtendimentosMes = schedulingRepository.getTotalAtendimentosMes(startOfMonth, endOfMonth);</b>
<b class="nc">&nbsp;        Integer totalAtendimentosCanceladosMes = schedulingRepository.getTotalAtendimentosCanceladosMes(startOfMonth, endOfMonth);</b>
<b class="nc">&nbsp;        if (totalFaturadoMes == null) {</b>
<b class="nc">&nbsp;            totalFaturadoMes = 0.0;</b>
&nbsp;        }
<b class="nc">&nbsp;        return new MonthDataDto(totalFaturadoMes, totalAtendimentosMes, totalAtendimentosCanceladosMes);</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;String&gt; getTopClientes() {
<b class="nc">&nbsp;        List&lt;String&gt; topServicos = schedulingRepository.getTopClientes();</b>
<b class="nc">&nbsp;        topServicos = topServicos.stream()</b>
<b class="nc">&nbsp;                .map(servico -&gt; servico.split(&quot;,&quot;)[0])</b>
<b class="nc">&nbsp;                .toList();</b>
<b class="nc">&nbsp;        System.out.println(&quot;Top Serviços: &quot; + topServicos);</b>
<b class="nc">&nbsp;        return topServicos;</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;Integer&gt; getAtendimentosDiaDaSemanaNoMes(LocalDate month) {
<b class="nc">&nbsp;        LocalDateTime startOfMonth = month.withDayOfMonth(1).atStartOfDay();</b>
<b class="nc">&nbsp;        LocalDateTime endOfMonth = month.withDayOfMonth(month.lengthOfMonth()).atTime(23, 59, 59);</b>
<b class="nc">&nbsp;        List&lt;Scheduling&gt; schedulings = schedulingRepository.findByStartDatetimeBetweenAndIsCanceledFalse(startOfMonth, endOfMonth);</b>
<b class="nc">&nbsp;        List&lt;Integer&gt; atendimentosDiaDaSemana = new ArrayList&lt;&gt;(7);</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; 7; i++) {</b>
<b class="nc">&nbsp;            atendimentosDiaDaSemana.add(0);</b>
&nbsp;        }
<b class="nc">&nbsp;        schedulings.forEach(</b>
&nbsp;                scheduling -&gt; {
<b class="nc">&nbsp;                    int index_dia_da_semana = scheduling.getStartDatetime().getDayOfWeek().getValue() - 1;</b>
<b class="nc">&nbsp;                    int oldValue = atendimentosDiaDaSemana.get(index_dia_da_semana);</b>
<b class="nc">&nbsp;                    atendimentosDiaDaSemana.set(index_dia_da_semana, oldValue+1);</b>
&nbsp;                }
&nbsp;        );
<b class="nc">&nbsp;        System.out.println(&quot;Atendimentos por dia da semana: &quot; + atendimentosDiaDaSemana);</b>
<b class="nc">&nbsp;        return atendimentosDiaDaSemana;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public LocalDate getDateFirstScheduling() {
<b class="nc">&nbsp;        return schedulingRepository.findFirstDateScheduling()</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new ElementNotFoundException(&quot;Nenhum agendamento encontrado&quot;))</b>
<b class="nc">&nbsp;                .toLocalDate();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void delete(Integer idScheduling) {
<b class="nc">&nbsp;        Scheduling scheduling = findById(idScheduling);</b>
<b class="nc">&nbsp;        scheduling.setCanceled(true);</b>
<b class="nc">&nbsp;        scheduling.setCanceledAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        schedulingRepository.save(scheduling);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-06-08 01:04</div>
</div>
</body>
</html>
